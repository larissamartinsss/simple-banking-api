@startuml create-account-sequence
footer Simple Banking API - Hexagonal Architecture
title <size:20>POST /api/v1/accounts - Create Account</size>

autonumber

actor Client

box Simple Banking API #lightblue
    participant "CreateAccountHandler" as Handler
    participant "CreateAccountProcessor" as Processor
    participant "AccountRepository" as Repo
    database SQLite
end box

Client -> Handler: [POST] /api/v1/accounts
note right: {"document_number": "12345678900"}

activate Handler

    Handler -> Handler: Decode JSON body
    opt #LightPink Invalid JSON
        Client <-- Handler: Http 400: Invalid request body
    end

    Handler -> Handler: Validate document_number
    note right
        Rules:
        - Required field
        - Min length: 11 chars
        - Max length: 14 chars
    end note
    
    opt #LightPink Validation error
        Client <-- Handler: Http 400: Validation failed
    end

    Handler -> Processor: Process(CreateAccountRequest)
    activate Processor

        Processor -> Repo: FindByDocumentNumber(document_number)
        activate Repo
            Repo -> SQLite: SELECT * FROM accounts\nWHERE document_number = ?
            
            opt #LightSalmon Database error
                Processor <-- Repo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Internal server error
            end
            
            opt #LightPink Account already exists
                Processor <-- Repo: Existing account found
                Handler <-- Processor: Error: duplicate
                Client <-- Handler: Http 409: Account already exists
            end
            
            Processor <-- Repo: nil (not found)
        deactivate Repo

        Processor -> Processor: Create Account entity
        note right: Set created_at timestamp

        Processor -> Repo: Create(account)
        activate Repo
            Repo -> SQLite: INSERT INTO accounts\n(document_number, created_at)\nVALUES (?, ?)
            
            opt #LightSalmon Insert error
                Processor <-- Repo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Failed to create account
            end
            
            Processor <-- Repo: Account with ID
        deactivate Repo

        Handler <-- Processor: CreateAccountResponse
    deactivate Processor

    Handler -> Handler: Encode JSON response

    Client <-- Handler: Http 201: Account created

deactivate Handler

note over Client
    Success Response (201):
    {
        "account_id": 1,
        "document_number": "12345678900",
        "created_at": "2025-11-21T10:00:00Z"
    }
end note

@enduml
