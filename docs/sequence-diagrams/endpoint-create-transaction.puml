@startuml create-transaction-sequence
footer Simple Banking API - Hexagonal Architecture
title <size:20>POST /v1/transactions - Create Transaction (Auto Normalization)</size>

autonumber

actor Client

box Simple Banking API #lightblue
    participant "CreateTransactionHandler" as Handler
    participant "CreateTransactionProcessor" as Processor
    participant "AccountRepository" as AccRepo
    participant "OperationTypeRepository" as OpRepo
    participant "TransactionRepository" as TxRepo
    database SQLite
end box

Client -> Handler: [POST] /v1/transactions
note right
    Headers: Idempotency-Key (required)
    Body: {
        "account_id": 1,
        "operation_type_id": 1,
        "amount": 50.0
    }
end note

activate Handler

    Handler -> Handler: Validate Idempotency-Key header
    opt #LightPink Missing Idempotency-Key
        Client <-- Handler: Http 400: Idempotency-Key header is required
    end

    Handler -> Handler: Check Idempotency-Key cache
    opt #LightCyan Request already processed
        Client <-- Handler: Http 200: Cached response
    end

    Handler -> Handler: Decode JSON body
    opt #LightPink Invalid JSON
        Client <-- Handler: Http 400: Invalid request body
    end

    Handler -> Handler: Validate input
    note right
        Rules:
        - account_id > 0
        - operation_type_id: 1-4
        - amount != 0
    end note
    
    opt #LightPink Validation error
        Client <-- Handler: Http 400: Validation failed
    end

    Handler -> Processor: Process(CreateTransactionRequest)
    activate Processor

        Processor -> AccRepo: FindByID(account_id)
        activate AccRepo
            AccRepo -> SQLite: SELECT * FROM accounts\nWHERE id = ?
            
            opt #LightSalmon Database error
                Processor <-- AccRepo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Internal server error
            end
            
            opt #LightPink Account not found
                Processor <-- AccRepo: nil (not found)
                Handler <-- Processor: Error: not found
                Client <-- Handler: Http 404: Account not found
            end
            
            Processor <-- AccRepo: Account entity
        deactivate AccRepo

        Processor -> OpRepo: FindByID(operation_type_id)
        activate OpRepo
            OpRepo -> SQLite: SELECT * FROM operation_types\nWHERE id = ?
            
            opt #LightSalmon Database error
                Processor <-- OpRepo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Internal server error
            end
            
            opt #LightPink Invalid operation type
                Processor <-- OpRepo: nil (not found)
                Handler <-- Processor: Error: invalid type
                Client <-- Handler: Http 400: Invalid operation type
            end
            
            Processor <-- OpRepo: OperationType entity
        deactivate OpRepo

        Processor -> Processor: ✨ Normalize Amount
        note right
            **Auto Normalization:**
            
            If Debit (1,2,3):
              amount = -|amount|
            
            If Credit (4):
              amount = |amount|
            
            Example:
            Purchase 50.0 → -50.0 ✅
        end note

        Processor -> Processor: Create Transaction entity

        Processor -> TxRepo: Create(transaction)
        activate TxRepo
            TxRepo -> SQLite: INSERT INTO transactions\n(account_id, operation_type_id,\namount, event_date)\nVALUES (?, ?, ?, NOW())
            note right: Amount stored with\ncorrect sign!
            
            opt #LightSalmon Insert error
                Processor <-- TxRepo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Failed to create transaction
            end
            
            Processor <-- TxRepo: Transaction with ID
        deactivate TxRepo

        Handler <-- Processor: CreateTransactionResponse
    deactivate Processor

    Handler -> Handler: Cache response if Idempotency-Key
    Handler -> Handler: Encode JSON response

    Client <-- Handler: Http 201: Transaction created

deactivate Handler

note over Client
    Success Response (201):
    {
        "transaction_id": 1,
        "account_id": 1,
        "operation_type_id": 1,
        "amount": -50.0,  ← Auto-normalized!
        "event_date": "2025-11-21T10:00:00Z"
    }
end note

@enduml
