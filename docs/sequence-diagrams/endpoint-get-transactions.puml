@startuml Get Transactions Endpoint Flow
footer Simple Banking API - Hexagonal Architecture
title <size:20>GET /v1/accounts/:accountId/transactions - Get Transactions (Paginated)</size>

autonumber

actor Client

box Simple Banking API #lightblue
    participant "GetTransactionsHandler" as Handler
    participant "GetTransactionsProcessor" as Processor
    participant "AccountRepository" as AccRepo
    participant "TransactionRepository" as TxRepo
    database SQLite
end box

Client -> Handler: [GET] /v1/accounts/{id}/transactions?limit=50&offset=0

activate Handler

    Handler -> Handler: Extract accountId from URL
    note right: chi.URLParam(r, "accountId")
    
    Handler -> Handler: Parse accountId to int64
    opt #LightPink Invalid format
        Client <-- Handler: Http 400: Invalid account ID format
    end

    Handler -> Handler: Validate accountId > 0
    opt #LightPink Invalid ID
        Client <-- Handler: Http 400: Account ID must be positive
    end

    Handler -> Handler: Parse query parameters
    note right
        - limit (default: 50, max: 100)
        - offset (default: 0)
    end note
    
    opt #LightPink Invalid limit/offset
        Client <-- Handler: Http 400: Invalid pagination parameters
    end

    Handler -> Processor: Process(GetTransactionsRequest)
    activate Processor

        Processor -> AccRepo: FindByID(accountId)
        activate AccRepo
            AccRepo -> SQLite: SELECT * FROM accounts\nWHERE id = ?
            
            opt #LightSalmon Database error
                Processor <-- AccRepo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Internal server error
            end
            
            opt #LightPink Account not found
                Processor <-- AccRepo: nil (not found)
                Handler <-- Processor: Error: not found
                Client <-- Handler: Http 404: Account not found
            end
            
            Processor <-- AccRepo: Account entity
        deactivate AccRepo

        Processor -> TxRepo: FindByAccountIDPaginated(accountId, limit, offset)
        activate TxRepo
            TxRepo -> SQLite: SELECT * FROM transactions\nWHERE account_id = ?\nORDER BY event_date DESC\nLIMIT ? OFFSET ?
            
            opt #LightSalmon Database error
                Processor <-- TxRepo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Internal server error
            end
            
            Processor <-- TxRepo: []Transaction
        deactivate TxRepo

        Processor -> TxRepo: CountByAccountID(accountId)
        activate TxRepo
            TxRepo -> SQLite: SELECT COUNT(*)\nFROM transactions\nWHERE account_id = ?
            
            opt #LightSalmon Database error
                Processor <-- TxRepo: Database Error
                Handler <-- Processor: Error 500
                Client <-- Handler: Http 500: Internal server error
            end
            
            Processor <-- TxRepo: total count
        deactivate TxRepo

        Processor -> Processor: Calculate pagination
        note right: total_pages = ceil(total / limit)

        Handler <-- Processor: GetTransactionsResponse
    deactivate Processor

    Handler -> Handler: Encode JSON response

    Client <-- Handler: Http 200: Transactions with pagination

deactivate Handler

note over Client
    Success Response (200):
    {
        "transactions": [
            {
                "transaction_id": 1,
                "account_id": 1,
                "operation_type_id": 4,
                "amount": 123.45,
                "event_date": "2025-11-21T10:00:00Z"
            }
        ],
        "pagination": {
            "limit": 50,
            "offset": 0,
            "total": 150,
            "total_pages": 3
        }
    }
end note

@enduml
